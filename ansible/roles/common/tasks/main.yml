---
# ============================================
# Role: common
# Purpose:
#   - Prepare base OS for Jenkins VM
#   - Install essential system packages
#   - Ensure apt is ready for further tooling
# ============================================

- name: Update apt package index
  apt:
    update_cache: yes
    cache_valid_time: 3600
  tags:
    - common
    - base

- name: Install base system dependencies required by all roles
  apt:
    name:
      - apt-transport-https     # Required for HTTPS-based APT repositories
      - ca-certificates         # SSL certificates for secure downloads
      - curl                    # Used by multiple installers (Docker, Node, Trivy)
      - wget                    # Backup download utility
      - gnupg                   # Required to add GPG keys
      - lsb-release             # OS release information
      - unzip                   # Required for binary installations (kustomize, etc.)
      - software-properties-common
      - git                     # Required for Jenkins checkout & GitOps commits
    state: present
  tags:
    - common
    - base

- name: Ensure system packages are upgraded safely
  apt:
    upgrade: dist
  tags:
    - common
    - base

# ============================================
# Azure CLI Installation
# Purpose:
#   - Required for Jenkins VM Managed Identity login
#   - Used for ACR authentication (az acr login)
# ============================================

- name: Add Microsoft GPG key for Azure CLI
  apt_key:
    url: https://packages.microsoft.com/keys/microsoft.asc
    state: present
  tags:
    - common
    - azure-cli

- name: Add Azure CLI APT repository
  apt_repository:
    repo: "deb [arch=amd64] https://packages.microsoft.com/repos/azure-cli/ {{ ansible_lsb.codename }} main"
    state: present
    filename: azure-cli
  tags:
    - common
    - azure-cli

- name: Update apt cache after adding Azure CLI repo
  apt:
    update_cache: yes
  tags:
    - common
    - azure-cli

- name: Install Azure CLI
  apt:
    name: azure-cli
    state: present
  tags:
    - common
    - azure-cli
