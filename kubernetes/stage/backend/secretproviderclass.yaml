apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: backend-secrets
  namespace: framely-stage
spec:
  provider: azure

  # ------------------------------------------------------------
  # Azure Key Vault configuration
  # ------------------------------------------------------------
  parameters:
    usePodIdentity: "false"
    useVMManagedIdentity: "true"

    # If you are using SYSTEM-assigned managed identity on AKS,
    # keep this empty.
    # If USER-assigned MI is used, put clientId here.
    userAssignedIdentityID: ""

    keyvaultName: kv-framely-stage
    tenantId: "fc9490dd-bfc5-45ed-8488-7927a690c913"

    objects: |
      array:
        - |
          objectName: backend-sql-connection-string
          objectType: secret
          objectVersion: ""

        - |
          objectName: backend-jwt-secret
          objectType: secret
          objectVersion: ""

        - |
          objectName: backend-blob-connection-string
          objectType: secret
          objectVersion: ""

        - |
          objectName: backend-blob-account-key
          objectType: secret
          objectVersion: ""

  # ------------------------------------------------------------
  # Sync secrets into Kubernetes Secret (runtime only)
  # This allows env var injection without code changes
  # ------------------------------------------------------------
  secretObjects:
    - secretName: backend-secrets
      type: Opaque
      data:
        - objectName: backend-sql-connection-string
          key: ConnectionStrings__DefaultConnection

        - objectName: backend-jwt-secret
          key: JwtSettings__Secret

        - objectName: backend-blob-connection-string
          key: Storage__ConnectionString

        - objectName: backend-blob-account-key
          key: Storage__Key
