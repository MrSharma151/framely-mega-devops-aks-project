apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: backend-secrets
  namespace: framely-stage
spec:
  provider: azure

  # ------------------------------------------------------------
  # Azure Key Vault configuration
  # ------------------------------------------------------------
  parameters:
    usePodIdentity: "false"
    useVMManagedIdentity: "true"

    # USER-assigned Managed Identity (AKS node identity)
    userAssignedIdentityID: "e69de585-e3a1-4752-ab65-45373100e0c7"

    keyvaultName: kv-framely-stage
    tenantId: "fc9490dd-bfc5-45ed-8488-7927a690c913"

    # ------------------------------------------------------------
    # Key Vault objects (ACTUAL secret names in KV)
    # ------------------------------------------------------------
    objects: |
      array:
        - |
          objectName: ConnectionStrings--DefaultConnection
          objectType: secret

        - |
          objectName: JwtSettings--Secret
          objectType: secret

        - |
          objectName: Storage--ConnectionString
          objectType: secret

        - |
          objectName: Storage--Container
          objectType: secret

        - |
          objectName: Storage--Name
          objectType: secret

        - |
          objectName: Storage--Key
          objectType: secret

  # ------------------------------------------------------------
  # ðŸ”¥ IMPORTANT PART: Sync into Kubernetes Secret
  # This fixes `--` vs `__` issue for ASP.NET Core
  # ------------------------------------------------------------
  secretObjects:
    - secretName: backend-secrets
      type: Opaque
      data:
        - objectName: ConnectionStrings--DefaultConnection
          key: ConnectionStrings__DefaultConnection

        - objectName: JwtSettings--Secret
          key: JwtSettings__Secret

        - objectName: Storage--ConnectionString
          key: Storage__ConnectionString

        - objectName: Storage--Container
          key: Storage__Container

        - objectName: Storage--Name
          key: Storage__Name

        - objectName: Storage--Key
          key: Storage__Key
